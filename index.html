<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Face Capture Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <!-- Header -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Face Capture Dashboard</h1>
      <div id="status-indicator" class="text-sm md:text-base">Loading statusâ€¦</div>
    </div>
  </header>

  <!-- Error / info banner -->
  <div id="banner" class="hidden">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div id="banner-inner" class="rounded-lg p-3"></div>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Control & List -->
    <section class="md:col-span-1 space-y-4">
      <!-- Control Card -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-lg">Remote Control</h2>
        </div>
        <button id="toggleBtn"
                class="w-full py-2 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed">
          Loadingâ€¦
        </button>
        <p id="control-help" class="text-xs text-gray-500 mt-2">
          Start/stop the capture app running on your PC. If the app is offline, youâ€™ll see an error.
        </p>
      </div>

      <!-- Images list -->
      <div class="bg-white rounded-xl shadow p-4 max-h-[70vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-lg">Captured Images</h2>
          <button id="refreshBtn"
                  class="text-sm px-3 py-1 rounded-md bg-gray-100 hover:bg-gray-200">
            Refresh
          </button>
        </div>
        <div id="list" class="space-y-2 text-sm">
          <p class="text-gray-500">Loading imagesâ€¦</p>
        </div>
      </div>
    </section>

    <!-- Preview -->
    <section class="md:col-span-2">
      <div class="bg-white rounded-xl shadow p-6 text-center">
        <p id="preview-caption" class="text-gray-500 mb-4">No image selected</p>
        <div id="preview-img" class="flex justify-center mb-4"></div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <button id="viewBtn"
                  class="py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50"
                  disabled>View Full</button>
          <button id="downloadBtn"
                  class="py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 disabled:opacity-50"
                  disabled>Download</button>
          <button id="deleteBtn"
                  class="py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 disabled:opacity-50"
                  disabled>Delete</button>
          <button id="refreshBtn2"
                  class="py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Refresh</button>
        </div>
      </div>
    </section>
  </main>

  <script>
    // === CONFIG (adjust if DB path changes) ===
    const BASE = "https://faceuploader-3347e-default-rtdb.firebaseio.com/";
    const URL_FACES   = BASE + "faces.json";
    const URL_FACE    = (key) => BASE + "faces/" + key + ".json";
    const URL_STATUS  = BASE + "status.json";               // { is_recognition_active: bool, last_active: "YYYY-mm-dd HH:MM:SS" }
    const URL_CONTROL = BASE + "control/start_recognition.json"; // true/false desired state

    // === State ===
    let entries = {};
    let selectedKey = null;
    let cachedStatus = { is_recognition_active: false, last_active: null };

    // === Utils ===
    function showBanner(type, msg) {
      // type: "error" | "info" | "success" | "warn"
      const banner = document.getElementById("banner");
      const inner = document.getElementById("banner-inner");
      const styles = {
        error: "bg-red-100 text-red-800 border border-red-200",
        info: "bg-blue-50 text-blue-800 border border-blue-200",
        success: "bg-green-50 text-green-800 border border-green-200",
        warn: "bg-yellow-50 text-yellow-800 border border-yellow-200"
      };
      inner.className = "rounded-lg p-3 " + (styles[type] || styles.info);
      inner.textContent = msg;
      banner.classList.remove("hidden");
      // Auto-hide after 6s
      setTimeout(() => banner.classList.add("hidden"), 6000);
    }

    function setStatusIndicator(active, lastActive) {
      const el = document.getElementById("status-indicator");
      if (active) {
        el.innerHTML = `<span class="bg-green-500/90 px-3 py-1 rounded-full">ðŸŸ¢ Capturing Faces</span>`;
      } else if (lastActive) {
        el.innerHTML = `<span class="bg-red-500/90 px-3 py-1 rounded-full">ðŸ”´ Last Active: ${lastActive}</span>`;
      } else {
        el.textContent = "No status data";
      }
      const toggle = document.getElementById("toggleBtn");
      toggle.textContent = active ? "Stop Recognition" : "Start Recognition";
      toggle.disabled = false;
    }

    function enablePreviewActions(enabled) {
      document.getElementById("viewBtn").disabled = !enabled;
      document.getElementById("downloadBtn").disabled = !enabled;
      document.getElementById("deleteBtn").disabled = !enabled;
    }

    // === Status & Control ===
    async function fetchStatus() {
      try {
        const res = await fetch(URL_STATUS, { cache: "no-store" });
        const data = await res.json();
        if (!data) {
          setStatusIndicator(false, null);
          cachedStatus = { is_recognition_active: false, last_active: null };
          return;
        }
        cachedStatus = data;
        setStatusIndicator(!!data.is_recognition_active, data.last_active || null);
      } catch (e) {
        setStatusIndicator(false, cachedStatus.last_active || null);
      }
    }

    async function toggleRemote() {
      const btn = document.getElementById("toggleBtn");
      btn.disabled = true;
      btn.textContent = "Workingâ€¦";

      // Desired state is the opposite of current
      const desired = !cachedStatus.is_recognition_active;

      try {
        // PUT desired state
        const put = await fetch(URL_CONTROL, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(desired)
        });
        if (!put.ok) throw new Error("Failed to send command");

        // Wait up to 10s for the Python app to reflect the state in /status
        const start = Date.now();
        let success = false;
        while (Date.now() - start < 10000) {
          await new Promise(r => setTimeout(r, 1000));
          await fetchStatus();
          if (cachedStatus.is_recognition_active === desired) {
            success = true;
            break;
          }
        }
        if (!success) {
          // Could not flip the state -> show error
          showBanner("error", desired
            ? "Could not start capture remotely. The device might be offline or the app isnâ€™t running."
            : "Could not stop capture remotely.");
        } else {
          showBanner("success", desired ? "Capture started remotely." : "Capture stopped.");
        }
      } catch (e) {
        showBanner("error", "Remote control failed. Check network/Firebase rules.");
      } finally {
        btn.disabled = false;
        btn.textContent = cachedStatus.is_recognition_active ? "Stop Recognition" : "Start Recognition";
      }
    }

    // === Images ===
    async function loadImages() {
      const list = document.getElementById("list");
      list.innerHTML = `<p class="text-gray-500">Loading imagesâ€¦</p>`;
      try {
        const res = await fetch(URL_FACES, { cache: "no-store" });
        const data = await res.json();
        entries = data || {};
        list.innerHTML = "";

        const keys = Object.keys(entries);
        if (keys.length === 0) {
          list.innerHTML = `<p class="text-gray-400">No images available</p>`;
          return;
        }

        // sort by timestamp desc
        const sorted = Object.entries(entries).sort((a, b) =>
          new Date(b[1].timestamp) - new Date(a[1].timestamp)
        );

        for (const [key, entry] of sorted) {
          const item = document.createElement("button");
          item.className =
            "w-full text-left p-3 rounded-lg border border-gray-100 bg-gray-50 hover:bg-blue-50 transition";
          item.textContent = entry.timestamp;
          item.onclick = () => selectImage(key);
          list.appendChild(item);
        }
      } catch (e) {
        list.innerHTML = `<p class="text-red-600">Failed to load images.</p>`;
      }
    }

    function selectImage(key) {
      selectedKey = key;
      const imgData = "data:image/jpeg;base64," + entries[key].image_base64;
      document.getElementById("preview-caption").textContent = entries[key].timestamp || "";
      document.getElementById("preview-img").innerHTML =
        `<img src="${imgData}" class="max-h-[420px] rounded-lg shadow" />`;
      enablePreviewActions(true);
    }

    function viewImage() {
      if (!selectedKey) return;
      const imgData = "data:image/jpeg;base64," + entries[selectedKey].image_base64;
      const w = window.open();
      w.document.write(`<img src="${imgData}" style="max-width:100%;height:auto" />`);
    }

    function downloadImage() {
      if (!selectedKey) return;
      const a = document.createElement("a");
      a.href = "data:image/jpeg;base64," + entries[selectedKey].image_base64;
      a.download = selectedKey + ".jpg";
      a.click();
    }

    async function deleteImage() {
      if (!selectedKey) return;
      if (!confirm("Delete this image?")) return;
      try {
        const res = await fetch(URL_FACE(selectedKey), { method: "DELETE" });
        if (!res.ok) throw new Error();
        showBanner("success", "Image deleted.");
        selectedKey = null;
        document.getElementById("preview-img").innerHTML = "";
        document.getElementById("preview-caption").textContent = "No image selected";
        enablePreviewActions(false);
        loadImages();
      } catch {
        showBanner("error", "Failed to delete image.");
      }
    }

    // === Wire up ===
    document.getElementById("toggleBtn").addEventListener("click", toggleRemote);
    document.getElementById("refreshBtn").addEventListener("click", loadImages);
    document.getElementById("refreshBtn2").addEventListener("click", loadImages);
    document.getElementById("viewBtn").addEventListener("click", viewImage);
    document.getElementById("downloadBtn").addEventListener("click", downloadImage);
    document.getElementById("deleteBtn").addEventListener("click", deleteImage);

    // Initial
    (async function init() {
      document.getElementById("toggleBtn").disabled = true;
      enablePreviewActions(false);
      await fetchStatus();
      await loadImages();
      // periodic status refresh
      setInterval(fetchStatus, 5000);
    })();
  </script>
</body>
</html>
