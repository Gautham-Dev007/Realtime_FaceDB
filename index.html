<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Face Capture Dashboard â€” Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- JSZip + FileSaver -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-L2sRjVb0QbDFZxK1qDLF70qLwVqv+1X0x8h1nA1sS3uKk3v7b7Q6kQ2o9YmdrAgG2w1DtdxW0dYrm3rH8b0QvA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-v3b6H0fQGm7q6yF8P2cK3R9Q8wz3a2bG1z+o8d8b3Dq0yF0ZQf2Dk2QpY1m2kLQ1M5vZ0a3r0OeJQy7M3eE9Ww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Firebase v9 modular (CDN) -->
  <script type="module">
    // This module is intentionally empty in HEAD; actual firebase init happens in body script
  </script>

  <style>
    /* tiny helpers */
    .hidden-by-auth { display: none; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">
  <!-- Header -->
  <header class="bg-blue-600 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-xl md:text-2xl font-bold">Face Capture Dashboard</h1>
      <div class="flex items-center gap-4">
        <div id="status-indicator" class="text-sm md:text-base">Not signed in</div>
        <div id="userInfo" class="text-sm hidden"></div>
        <button id="signInBtn" class="py-1 px-3 rounded bg-white text-blue-600 hover:bg-gray-100">Sign in</button>
        <button id="signOutBtn" class="py-1 px-3 rounded bg-red-500 text-white hover:bg-red-600 hidden">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Banner -->
  <div id="banner" class="hidden">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div id="banner-inner" class="rounded-lg p-3"></div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="authModal" class="fixed inset-0 bg-black/40 flex items-center justify-center hidden z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
      <h3 class="text-lg font-semibold mb-3">Sign in / Register</h3>
      <div id="authStep1">
        <label class="block text-sm">Email</label>
        <input id="authEmail" type="email" class="w-full border rounded px-3 py-2 mb-2" />
        <label class="block text-sm">Password</label>
        <input id="authPassword" type="password" class="w-full border rounded px-3 py-2 mb-4" />
        <div class="flex gap-2">
          <button id="doSignIn" class="flex-1 py-2 rounded bg-blue-600 text-white">Sign in</button>
          <button id="doRegister" class="flex-1 py-2 rounded bg-gray-200">Register</button>
        </div>
        <p class="text-xs text-gray-500 mt-3">Admins manage users and enable 2FA. Registration creates a normal user.</p>
      </div>

      <!-- OTP step for 2FA -->
      <div id="authOtpStep" class="hidden">
        <p class="text-sm mb-2">Enter the 6-digit code sent to your email</p>
        <input id="authOtp" type="text" maxlength="6" class="w-full border rounded px-3 py-2 mb-3" />
        <div class="flex gap-2">
          <button id="verifyOtpBtn" class="flex-1 py-2 rounded bg-emerald-600 text-white">Verify</button>
          <button id="cancelOtpBtn" class="flex-1 py-2 rounded bg-gray-200">Cancel</button>
        </div>
      </div>

      <div class="mt-4 text-right">
        <button id="closeAuthModal" class="text-sm text-gray-500">Close</button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <!-- Controls row -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Remote control -->
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Remote Control</h2>
        <button id="toggleBtn"
          class="w-full py-2 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50" disabled>
          Loadingâ€¦
        </button>
        <p class="text-xs text-gray-500">
          Controls the capture app on your PC via Firebase Realtime Database.
        </p>
        <div class="text-sm text-gray-700">
          <div>Last active: <span id="lastActive">â€”</span></div>
          <div class="text-red-600" id="statusError"></div>
        </div>
        <div id="adminBadge" class="text-xs text-white bg-indigo-600 inline-block px-2 py-1 rounded hidden">Admin</div>
      </div>

      <!-- Latest detection -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-lg">Latest Detection</h2>
          <button id="refreshBtn"
                  class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">
            Refresh
          </button>
        </div>
        <div id="latestWrap" class="flex flex-col items-center">
          <p class="text-gray-500" id="latestCaption">Waitingâ€¦</p>
          <div id="latestImg" class="mt-3"></div>
        </div>
      </div>

      <!-- Bulk actions -->
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Bulk Actions</h2>
        <div class="flex flex-wrap gap-2">
          <button id="selectAllBtn" class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">Select All</button>
          <button id="deselectAllBtn" class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">Deselect All</button>
          <button id="downloadSelBtn" class="py-2 px-3 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Download Selected (ZIP)</button>
          <button id="deleteSelBtn" class="py-2 px-3 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm">Delete Selected</button>
        </div>
        <p class="text-xs text-gray-500">
          Tip: You can also click images to toggle selection.
        </p>
      </div>
    </section>

    <!-- Gallery -->
    <section class="bg-white rounded-xl shadow p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Recent Faces</h2>
        <span id="countBadge" class="text-xs bg-gray-100 rounded-full px-2 py-1"></span>
      </div>
      <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
        <!-- items injected -->
      </div>
    </section>

    <!-- Admin Panel -->
    <section id="adminPanel" class="bg-white rounded-xl shadow p-4 hidden">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Admin Panel</h2>
        <div class="text-sm text-gray-500">Only visible to admins</div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Invite user -->
        <div class="p-3 border rounded">
          <h3 class="font-medium mb-2">Invite / Create User</h3>
          <input id="newUserEmail" type="email" placeholder="user@example.com" class="w-full border rounded px-2 py-1 mb-2">
          <select id="newUserRole" class="w-full border rounded px-2 py-1 mb-2">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
          <button id="createUserBtn" class="py-2 px-3 rounded bg-blue-600 text-white">Create (secure)</button>
          <p class="text-xs text-gray-500 mt-2">This will call a secure Cloud Function that creates the user and (optionally) marks them admin. Replace with your function URL in the code.</p>
        </div>

        <!-- Admin user list & 2FA toggle -->
        <div class="p-3 border rounded">
          <h3 class="font-medium mb-2">Manage Users</h3>
          <div id="userList" class="space-y-2 max-h-48 overflow-auto"></div>
          <button id="refreshUsersBtn" class="mt-3 py-2 px-3 rounded bg-gray-200">Refresh Users</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Firebase + App Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getDatabase, ref, get, set, onValue, child, update, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    /************* CONFIG - Replace with your Firebase project's config *************/
    const firebaseConfig = {
      apiKey: "<YOUR_API_KEY>",
      authDomain: "<YOUR_AUTH_DOMAIN>",
      databaseURL: "<YOUR_RTDB_URL>", // e.g. https://your-project-default-rtdb.firebaseio.com
      projectId: "<YOUR_PROJECT_ID>",
      // ... other fields as provided by Firebase console
    };
    /*********************************************************************************/

    // Cloud Function endpoints (deploy these on your server / Firebase Functions)
    // Replace these URLs with your deployed function endpoints.
    const CF_CREATE_USER = "<CLOUD_FUNCTION_URL>/createUser";       // POST {email, password, role}
    const CF_SET_ADMIN   = "<CLOUD_FUNCTION_URL>/setAdmin";         // POST {uid, isAdmin}
    const CF_LIST_USERS  = "<CLOUD_FUNCTION_URL>/listUsers";        // GET -> returns user list
    const CF_SEND_OTP    = "<CLOUD_FUNCTION_URL>/sendOtp";          // POST {uid}
    const CF_VERIFY_OTP  = "<CLOUD_FUNCTION_URL>/verifyOtp";        // POST {uid, otp}

    // Initialize firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI elements
    const bannerEl = document.getElementById("banner");
    const bannerInner = document.getElementById("banner-inner");
    function banner(type, msg) {
      const cls = {
        error: "bg-red-100 text-red-800 border border-red-200",
        success: "bg-green-50 text-green-800 border border-green-200",
        info: "bg-blue-50 text-blue-800 border border-blue-200",
        warn: "bg-yellow-50 text-yellow-800 border border-yellow-200"
      }[type] || "bg-blue-50 text-blue-800 border border-blue-200";
      bannerInner.className = "rounded-lg p-3 " + cls;
      bannerInner.textContent = msg;
      bannerEl.classList.remove("hidden");
      setTimeout(() => bannerEl.classList.add("hidden"), 5000);
    }

    // Basic app state
    let currentUser = null;
    let isAdmin = false;

    // Original Firebase DB endpoints used in your app
    const BASE = firebaseConfig.databaseURL.endsWith('/') ? firebaseConfig.databaseURL : firebaseConfig.databaseURL + '/';
    const URL_FACES   = BASE + "faces.json";
    const URL_FACE    = (key) => BASE + "faces/" + key + ".json";
    const URL_STATUS  = BASE + "status.json";
    const URL_CONTROL = BASE + "control/start_recognition.json";

    // Cached status and faces
    let cachedStatus = { is_recognition_active: false, last_active: null, error: "" };
    let faces = [];

    // DOM refs used later
    const statusIndicator = document.getElementById("status-indicator");
    const signInBtn = document.getElementById("signInBtn");
    const signOutBtn = document.getElementById("signOutBtn");
    const userInfo = document.getElementById("userInfo");
    const adminPanel = document.getElementById("adminPanel");
    const adminBadge = document.getElementById("adminBadge");

    // Auth modal refs
    const authModal = document.getElementById("authModal");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const doSignIn = document.getElementById("doSignIn");
    const doRegister = document.getElementById("doRegister");
    const closeAuthModal = document.getElementById("closeAuthModal");
    const authOtpStep = document.getElementById("authOtpStep");
    const authStep1 = document.getElementById("authStep1");
    const authOtp = document.getElementById("authOtp");
    const verifyOtpBtn = document.getElementById("verifyOtpBtn");
    const cancelOtpBtn = document.getElementById("cancelOtpBtn");

    // Admin panel refs
    const createUserBtn = document.getElementById("createUserBtn");
    const newUserEmail = document.getElementById("newUserEmail");
    const newUserRole = document.getElementById("newUserRole");
    const userListEl = document.getElementById("userList");
    const refreshUsersBtn = document.getElementById("refreshUsersBtn");

    // Other app refs (gallery etc)
    const toggleBtn = document.getElementById("toggleBtn");
    const refreshBtn = document.getElementById("refreshBtn");
    const lastActive = document.getElementById("lastActive");
    const statusError = document.getElementById("statusError");
    const latestCaption = document.getElementById("latestCaption");
    const latestImg = document.getElementById("latestImg");
    const gallery = document.getElementById("gallery");
    const countBadge = document.getElementById("countBadge");
    const selectAllBtn = document.getElementById("selectAllBtn");
    const deselectAllBtn = document.getElementById("deselectAllBtn");
    const downloadSelBtn = document.getElementById("downloadSelBtn");
    const deleteSelBtn = document.getElementById("deleteSelBtn");

    // UI helpers
    function showAuthModal() { authModal.classList.remove("hidden"); }
    function hideAuthModal() { authModal.classList.add("hidden"); authOtpStep.classList.add("hidden"); authStep1.classList.remove("hidden"); }

    // ===== Authentication flows =====
    signInBtn.addEventListener("click", showAuthModal);
    closeAuthModal.addEventListener("click", hideAuthModal);

    doRegister.addEventListener("click", async () => {
      const email = authEmail.value.trim();
      const pass = authPassword.value;
      if (!email || !pass) return banner("warn", "Enter both email and password");
      try {
        // Creates user client-side (this creates an Auth account)
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        // Send verification email
        await sendEmailVerification(cred.user);
        banner("success", "Registered. Verification email sent.");
        hideAuthModal();
      } catch (err) {
        console.error(err);
        banner("error", "Registration failed: " + (err.message || err.code));
      }
    });

    doSignIn.addEventListener("click", async () => {
      const email = authEmail.value.trim();
      const pass = authPassword.value;
      if (!email || !pass) return banner("warn", "Enter both email and password");
      try {
        const cred = await signInWithEmailAndPassword(auth, email, pass);
        // After sign-in, check if 2FA is enabled for user
        const uid = cred.user.uid;
        const user2faSnap = await get(ref(db, `userMeta/${uid}`));
        const meta = user2faSnap.val() || {};
        if (meta.twoFactorEnabled) {
          // request server to send OTP
          banner("info", "2FA enabled: requesting OTP...");
          // call Cloud Function to send OTP to user email (server chooses transport)
          await fetch(CF_SEND_OTP, {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify({ uid })
          });
          // show OTP step
          authStep1.classList.add("hidden");
          authOtpStep.classList.remove("hidden");
        } else {
          hideAuthModal();
        }
      } catch (err) {
        console.error(err);
        banner("error", "Sign in failed: " + (err.message || err.code));
      }
    });

    verifyOtpBtn.addEventListener("click", async () => {
      const otp = authOtp.value.trim();
      const user = auth.currentUser;
      if (!user) return banner("error", "No user session");
      if (!otp) return banner("warn", "Enter the OTP");
      try {
        const res = await fetch(CF_VERIFY_OTP, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ uid: user.uid, otp })
        });
        const j = await res.json();
        if (res.ok && j.success) {
          banner("success", "2FA verification OK");
          hideAuthModal();
        } else {
          banner("error", "OTP invalid");
        }
      } catch (err) {
        console.error(err);
        banner("error", "OTP verification failed");
      }
    });

    cancelOtpBtn.addEventListener("click", async () => {
      // If user cancelled OTP, sign them out
      await signOut(auth);
      authStep1.classList.remove("hidden");
      authOtpStep.classList.add("hidden");
      banner("info", "2FA cancelled.");
    });

    signOutBtn.addEventListener("click", async () => {
      await signOut(auth);
      banner("info", "Signed out");
    });

    // Monitor auth state
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (user) {
        signInBtn.classList.add("hidden");
        signOutBtn.classList.remove("hidden");
        userInfo.classList.remove("hidden");
        userInfo.textContent = user.email || user.uid;
        statusIndicator.textContent = "Signed in";
        // check admin status from DB path /admins/<uid> === true
        const adminSnap = await get(ref(db, `admins/${user.uid}`));
        isAdmin = !!adminSnap.val();
        adminPanel.classList.toggle("hidden", !isAdmin);
        adminBadge.classList.toggle("hidden", !isAdmin);

        // enable admin-only controls
        toggleBtn.disabled = !isAdmin;
      } else {
        signInBtn.classList.remove("hidden");
        signOutBtn.classList.add("hidden");
        userInfo.classList.add("hidden");
        adminPanel.classList.add("hidden");
        adminBadge.classList.add("hidden");
        statusIndicator.textContent = "Not signed in";
        isAdmin = false;
        toggleBtn.disabled = true;
      }
    });

    // ===== Admin actions wired to Cloud Functions =====
    createUserBtn.addEventListener("click", async () => {
      const email = newUserEmail.value.trim();
      const role = newUserRole.value;
      if (!email) return banner("warn", "Enter an email");
      // call cloud function securely (must validate caller is admin on server)
      try {
        const res = await fetch(CF_CREATE_USER, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ email, role })
        });
        const j = await res.json();
        if (res.ok) {
          banner("success", `User created: ${j.uid || "(invited)"}`);
          newUserEmail.value = "";
          await loadUserList();
        } else {
          banner("error", j.error || "Create user failed");
        }
      } catch (err) {
        console.error(err);
        banner("error", "Create user request failed");
      }
    });

    // refresh users (admin)
    refreshUsersBtn.addEventListener("click", loadUserList);

    async function loadUserList() {
      userListEl.innerHTML = "Loadingâ€¦";
      try {
        const res = await fetch(CF_LIST_USERS);
        const j = await res.json();
        if (!res.ok) throw new Error(j.error || "failed");
        // j.users should be [{uid,email,role,twoFactorEnabled}, ...]
        userListEl.innerHTML = "";
        j.users.forEach(u => {
          const row = document.createElement("div");
          row.className = "flex items-center justify-between gap-2 p-2 border rounded";
          row.innerHTML = `
            <div class="text-sm truncate">${u.email || u.uid}</div>
            <div class="flex items-center gap-2">
              <label class="text-xs flex items-center gap-1"><input type="checkbox" ${u.role==="admin" ? "checked":""} data-uid="${u.uid}" class="adminToggle"> Admin</label>
              <label class="text-xs flex items-center gap-1"><input type="checkbox" ${u.twoFactorEnabled ? "checked":""} data-uid="${u.uid}" class="twofaToggle"> 2FA</label>
            </div>
          `;
          userListEl.appendChild(row);
        });

        // hook toggles
        document.querySelectorAll(".adminToggle").forEach(cb => {
          cb.addEventListener("change", async (ev) => {
            const uid = ev.target.dataset.uid;
            const isAdminSet = ev.target.checked;
            // call secure cloud function to set admin claim or update admin list
            try {
              const r = await fetch(CF_SET_ADMIN, {
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ uid, isAdmin: isAdminSet })
              });
              const j = await r.json();
              if (r.ok) banner("success", `Admin ${isAdminSet ? "enabled":"disabled"} for ${uid}`);
              else banner("error", j.error || "Failed to update admin");
            } catch (err) {
              console.error(err);
              banner("error", "Request failed");
            }
          });
        });

        document.querySelectorAll(".twofaToggle").forEach(cb => {
          cb.addEventListener("change", async (ev) => {
            const uid = ev.target.dataset.uid;
            const enable = ev.target.checked;
            // call CF to enable/disable 2FA
            try {
              const r = await fetch(CF_SET_ADMIN.replace("/setAdmin","/set2fa"), { // example endpoint path
                method: "POST",
                headers: {"Content-Type":"application/json"},
                body: JSON.stringify({ uid, enable })
              });
              const j = await r.json();
              if (r.ok) banner("success", `2FA ${enable ? "enabled":"disabled"} for ${uid}`);
              else banner("error", j.error || "Failed to update 2FA");
            } catch (err) {
              console.error(err);
              banner("error", "Request failed");
            }
          });
        });

      } catch (err) {
        console.error(err);
        userListEl.innerHTML = "Failed to load users";
        banner("error", "Failed to load user list");
      }
    }

    // ===== Faces: load, render, select, download, delete =====
    function renderLatest(entry) {
      const cap = latestCaption;
      const box = latestImg;
      if (!entry) {
        cap.textContent = "No images yet";
        box.innerHTML = "";
        return;
      }
      cap.textContent = entry.timestamp || "";
      box.innerHTML = `<img class="rounded-lg shadow max-h-72" src="data:image/jpeg;base64,${entry.image_base64}" alt="latest" />`;
    }

    function renderGallery() {
      gallery.innerHTML = "";
      countBadge.textContent = faces.length.toString();

      if (!faces.length) {
        gallery.innerHTML = `<div class="col-span-full text-gray-400 text-center py-6">No faces yet</div>`;
        renderLatest(null);
        return;
      }

      renderLatest(faces[0]);

      for (const f of faces) {
        const card = document.createElement("div");
        card.className = `relative border rounded-lg overflow-hidden bg-white hover:shadow transition`;

        const imgWrap = document.createElement("div");
        imgWrap.className = "cursor-pointer";
        imgWrap.innerHTML = `
          <img class="w-full aspect-square object-cover" src="data:image/jpeg;base64,${f.image_base64}" alt="${f.timestamp || ""}">
        `;

        const meta = document.createElement("div");
        meta.className = "px-2 py-2 text-xs text-gray-700 flex items-center justify-between";
        meta.innerHTML = `
          <span class="truncate">${f.timestamp || ""}</span>
          <input type="checkbox" class="h-4 w-4" ${f.selected ? "checked" : ""}>
        `;

        // click image toggles selection
        imgWrap.onclick = () => {
          f.selected = !f.selected;
          checkbox.checked = f.selected;
          card.classList.toggle("ring-2", f.selected);
          card.classList.toggle("ring-blue-500", f.selected);
        };

        const checkbox = meta.querySelector("input[type=checkbox]");
        checkbox.addEventListener("change", () => {
          f.selected = checkbox.checked;
          card.classList.toggle("ring-2", f.selected);
          card.classList.toggle("ring-blue-500", f.selected);
        });

        card.appendChild(imgWrap);
        card.appendChild(meta);
        gallery.appendChild(card);

        if (f.selected) {
          card.classList.add("ring-2", "ring-blue-500");
        }
      }
    }

    async function loadFaces() {
      refreshBtn.disabled = true;
      try {
        const res = await fetch(URL_FACES, { cache: "no-store" });
        const data = await res.json();
        if (!data) {
          faces = [];
          renderGallery();
          return;
        }
        faces = Object.entries(data)
          .map(([key, v]) => ({ key, ...v, selected: false }))
          .sort((a, b) => (new Date(b.timestamp || 0)) - (new Date(a.timestamp || 0)));
        renderGallery();
      } catch (err) {
        banner("error", "Failed to load images.");
        console.error(err);
      } finally {
        refreshBtn.disabled = false;
      }
    }

    function selectAll(val) {
      faces.forEach(f => f.selected = val);
      renderGallery();
    }

    function b64ToUint8Array(b64) {
      const binary = atob(b64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    async function downloadSelectedZip() {
      const selected = faces.filter(f => f.selected);
      if (!selected.length) {
        banner("warn", "No images selected.");
        return;
      }
      const zip = new JSZip();
      selected.forEach((f, idx) => {
        const bytes = b64ToUint8Array(f.image_base64);
        const safeTs = (f.timestamp || `img_${idx}`).replace(/[:\s]/g, "_");
        zip.file(`${safeTs}_${f.key}.jpg`, bytes);
      });
      const blob = await zip.generateAsync({ type: "blob" });
      saveAs(blob, `faces_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
    }

    async function deleteSelected() {
      const selected = faces.filter(f => f.selected);
      if (!selected.length) {
        banner("warn", "No images selected.");
        return;
      }
      if (!confirm(`Delete ${selected.length} image(s)? This cannot be undone.`)) return;

      let ok = 0, fail = 0;
      for (const f of selected) {
        try {
          const r = await fetch(URL_FACE(f.key), { method: "DELETE" });
          if (r.ok) ok++; else fail++;
        } catch {
          fail++;
        }
      }
      banner(fail ? "warn" : "success", `Deleted ${ok} image(s)` + (fail ? `, failed ${fail}` : ""));
      await loadFaces();
    }

    // ===== Remote control =====
    function setStatusUI() {
      const el = statusIndicator;
      const last = lastActive;
      const err = statusError;

      if (cachedStatus.error) {
        err.textContent = cachedStatus.error || "";
      } else {
        err.textContent = "";
      }

      last.textContent = cachedStatus.last_active || "â€”";

      if (cachedStatus.is_recognition_active) {
        el.innerHTML = `<span class="bg-green-500/90 px-3 py-1 rounded-full">ðŸŸ¢ Capturing Faces</span>`;
      } else {
        el.innerHTML = `<span class="bg-red-500/90 px-3 py-1 rounded-full">ðŸ”´ Stopped</span>`;
      }

      const btn = toggleBtn;
      btn.disabled = !isAdmin;
      btn.textContent = cachedStatus.is_recognition_active ? "Stop Recognition" : "Start Recognition";
    }

    async function fetchStatus() {
      try {
        const res = await fetch(URL_STATUS, { cache: "no-store" });
        const data = await res.json();
        cachedStatus = data || { is_recognition_active: false, last_active: null, error: "Device offline" };
      } catch (err) {
        cachedStatus = { is_recognition_active: false, last_active: cachedStatus.last_active || null, error: "Network error" };
      }
      setStatusUI();
    }

    async function toggleRemote() {
      if (!isAdmin) { banner("error", "Admin required"); return; }
      const btn = toggleBtn;
      btn.disabled = true;
      btn.textContent = "Workingâ€¦";
      const desired = !cachedStatus.is_recognition_active;
      try {
        const r = await fetch(URL_CONTROL, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(desired)
        });
        if (!r.ok) throw new Error("control write failed");
        // wait briefly for status to reflect
        const start = Date.now();
        let ok = false;
        while (Date.now() - start < 8000) {
          await new Promise(r => setTimeout(r, 800));
          await fetchStatus();
          if (cachedStatus.is_recognition_active === desired) { ok = true; break; }
        }
        if (!ok) banner("warn", desired ? "Could not confirm start. App may be offline/camera busy." : "Could not confirm stop.");
        else banner("success", desired ? "Capture started." : "Capture stopped.");
      } catch (err) {
        console.error(err);
        banner("error", "Remote control failed (network/rules).");
      } finally {
        btn.disabled = !isAdmin;
        btn.textContent = cachedStatus.is_recognition_active ? "Stop Recognition" : "Start Recognition";
      }
    }

    // ===== events wiring =====
    toggleBtn.addEventListener("click", toggleRemote);
    refreshBtn.addEventListener("click", async () => {
      await fetchStatus();
      await loadFaces();
    });
    selectAllBtn.addEventListener("click", () => selectAll(true));
    deselectAllBtn.addEventListener("click", () => selectAll(false));
    downloadSelBtn.addEventListener("click", downloadSelectedZip);
    deleteSelBtn.addEventListener("click", deleteSelected);

    // ===== Init =====
    (async function init() {
      toggleBtn.disabled = true;
      await fetchStatus();
      await loadFaces();
      // light polling
      setInterval(fetchStatus, 5000);
      setInterval(loadFaces, 5000);
    })();

  </script>
</body>
</html>
