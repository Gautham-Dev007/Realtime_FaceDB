<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Face Capture Dashboard â€” Secure</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JSZip + FileSaver for ZIP downloads (free, client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-L2sRjVb0QbDFZxK1qDLF70qLwVqv+1X0x8h1nA1sS3uKk3v7b7Q6kQ2o9YmdrAgG2w1DtdxW0dYrm3rH8b0QvA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js" integrity="sha512-v3b6H0fQGm7q6yF8P2cK3R9Q8wz3a2bG1z+o8d8b3Dq0yF0ZQf2Dk2QpY1m2kLQ1M5vZ0a3r0OeJQy7M3eE9Ww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

<!-- HEADER -->
<header class="bg-blue-600 text-white shadow">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <h1 class="text-xl md:text-2xl font-bold">Face Capture Dashboard â€” Secure</h1>
    <div id="auth-area" class="flex items-center gap-3 text-sm">
      <!-- signed-in UI injected -->
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
  <!-- AUTH / INFO -->
  <section id="auth-section" class="bg-white rounded-xl shadow p-4">
    <h2 class="font-semibold text-lg">Authentication</h2>
    <div id="auth-forms" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="p-3 border rounded">
        <h3 class="font-medium">Sign up (email)</h3>
        <input id="signupEmail" class="w-full mt-2 p-2 border rounded" placeholder="Email" />
        <input id="signupPassword" type="password" class="w-full mt-2 p-2 border rounded" placeholder="Password" />
        <button id="signupBtn" class="mt-2 w-full p-2 bg-emerald-600 text-white rounded">Create account</button>
        <p class="text-xs text-gray-500 mt-2">After signing up you'll be registered as a regular user. Admins can promote users.</p>
      </div>

      <div class="p-3 border rounded">
        <h3 class="font-medium">Sign in (email)</h3>
        <input id="signinEmail" class="w-full mt-2 p-2 border rounded" placeholder="Email" />
        <input id="signinPassword" type="password" class="w-full mt-2 p-2 border rounded" placeholder="Password" />
        <button id="signinBtn" class="mt-2 w-full p-2 bg-blue-600 text-white rounded">Sign in</button>
        <button id="sendResetBtn" class="mt-2 w-full p-2 bg-gray-200 rounded">Send password reset</button>
      </div>

      <div class="p-3 border rounded">
        <h3 class="font-medium">Phone 2FA (optional)</h3>
        <div id="recaptcha-container"></div>
        <input id="phoneNumber" class="w-full mt-2 p-2 border rounded" placeholder="+91XXXXXXXXXX" />
        <button id="sendCodeBtn" class="mt-2 w-full p-2 bg-yellow-500 text-white rounded">Send verification code</button>
        <input id="phoneCode" class="w-full mt-2 p-2 border rounded" placeholder="Verification code" />
        <button id="verifyPhoneBtn" class="mt-2 w-full p-2 bg-green-600 text-white rounded">Verify phone (link to account)</button>
        <p class="text-xs text-gray-500 mt-2">If you verify your phone it can be required as a second factor before accessing sensitive actions.</p>
      </div>
    </div>
  </section>

  <!-- Admin panel -->
  <section id="admin-section" class="hidden bg-white rounded-xl shadow p-4">
    <div class="flex items-center justify-between mb-3">
      <h2 class="font-semibold text-lg">Admin Panel</h2>
      <div class="text-sm text-gray-600">Manage users & roles</div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-3 border rounded">
        <h3 class="font-medium">Users</h3>
        <div id="usersList" class="mt-2 text-sm"></div>
      </div>

      <div class="p-3 border rounded">
        <h3 class="font-medium">Invite / Manage</h3>
        <input id="inviteEmail" class="w-full mt-2 p-2 border rounded" placeholder="Email to invite" />
        <button id="inviteBtn" class="mt-2 w-full p-2 bg-indigo-600 text-white rounded">Send invite (email link)</button>
        <p class="text-xs text-gray-500 mt-2">Invited users will receive a magic link to sign in. After they sign in, admin can promote them.</p>
      </div>
    </div>
  </section>

  <!-- Existing dashboard controls (only shown when authenticated) -->
  <section id="controls-section" class="hidden bg-white rounded-xl shadow p-4">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <!-- Remote control -->
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Remote Control</h2>
        <button id="toggleBtn" class="w-full py-2 rounded-lg font-medium bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50">Loadingâ€¦</button>
        <p class="text-xs text-gray-500">Controls the capture app on your PC via Firebase Realtime Database.</p>
        <div class="text-sm text-gray-700"><div>Last active: <span id="lastActive">â€”</span></div><div class="text-red-600" id="statusError"></div></div>
      </div>

      <!-- Latest detection -->
      <div class="bg-white rounded-xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold text-lg">Latest Detection</h2>
          <button id="refreshBtn" class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">Refresh</button>
        </div>
        <div id="latestWrap" class="flex flex-col items-center">
          <p class="text-gray-500" id="latestCaption">Waitingâ€¦</p>
          <div id="latestImg" class="mt-3"></div>
        </div>
      </div>

      <!-- Bulk actions -->
      <div class="bg-white rounded-xl shadow p-4 space-y-3">
        <h2 class="font-semibold text-lg">Bulk Actions</h2>
        <div class="flex flex-wrap gap-2">
          <button id="selectAllBtn" class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">Select All</button>
          <button id="deselectAllBtn" class="py-2 px-3 rounded-lg bg-gray-200 hover:bg-gray-300 text-sm">Deselect All</button>
          <button id="downloadSelBtn" class="py-2 px-3 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Download Selected (ZIP)</button>
          <button id="deleteSelBtn" class="py-2 px-3 rounded-lg bg-red-600 text-white hover:bg-red-700 text-sm">Delete Selected</button>
        </div>
        <p class="text-xs text-gray-500">Tip: You can also click images to toggle selection.</p>
      </div>
    </div>

    <!-- Gallery -->
    <div class="bg-white rounded-xl shadow p-4 mt-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold text-lg">Recent Faces</h2>
        <span id="countBadge" class="text-xs bg-gray-100 rounded-full px-2 py-1"></span>
      </div>
      <div id="gallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
    </div>
  </section>

</main>

<script>
  // ----------------------
  // CONFIG: put your Firebase config here
  // ----------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    databaseURL: "YOUR_DATABASE_URL",
    projectId: "YOUR_PROJECT_ID",
    // ...
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Replace these with your existing DB endpoints
  const BASE = firebaseConfig.databaseURL || "https://faceuploader-3347e-default-rtdb.firebaseio.com/";
  const URL_FACES   = BASE + "faces.json";
  const URL_FACE    = (key) => BASE + "faces/" + key + ".json";
  const URL_STATUS  = BASE + "status.json";
  const URL_CONTROL = BASE + "control/start_recognition.json";

  // ----------------------
  // Simple client-side role check
  // roles/uid = {role: 'admin'|'user'}
  // users/uid = {email, createdAt, phoneVerified}
  // ----------------------

  // UI helpers
  function showBanner(type, msg) {
    alert(type.toUpperCase()+": "+msg);
  }

  // AUTH UI wiring
  const authArea = document.getElementById('auth-area');
  function setAuthArea(user) {
    authArea.innerHTML = '';
    if (!user) {
      const btn = document.createElement('button');
      btn.textContent = 'Sign in';
      btn.className = 'px-3 py-1 bg-white text-blue-600 rounded';
      btn.onclick = () => document.getElementById('auth-section').scrollIntoView();
      authArea.appendChild(btn);
      return;
    }
    const span = document.createElement('span');
    span.textContent = user.email || user.phoneNumber || '(user)';
    const out = document.createElement('button');
    out.textContent = 'Sign out';
    out.className = 'px-3 py-1 bg-white text-blue-600 rounded';
    out.onclick = () => auth.signOut();
    authArea.appendChild(span);
    authArea.appendChild(out);
  }

  // Sign up
  document.getElementById('signupBtn').addEventListener('click', async () => {
    const email = document.getElementById('signupEmail').value.trim();
    const pw = document.getElementById('signupPassword').value;
    if (!email || !pw) return showBanner('error', 'Provide email and password');
    try {
      const cred = await auth.createUserWithEmailAndPassword(email, pw);
      const user = cred.user;
      await db.ref('users/' + user.uid).set({ email: user.email, createdAt: Date.now(), phoneVerified: false });
      showBanner('success', 'Account created. Please sign in.');
    } catch (e) { showBanner('error', e.message); }
  });

  // Sign in
  document.getElementById('signinBtn').addEventListener('click', async () => {
    const email = document.getElementById('signinEmail').value.trim();
    const pw = document.getElementById('signinPassword').value;
    if (!email || !pw) return showBanner('error', 'Provide email and password');
    try {
      await auth.signInWithEmailAndPassword(email, pw);
    } catch (e) { showBanner('error', e.message); }
  });

  // Password reset
  document.getElementById('sendResetBtn').addEventListener('click', async () => {
    const email = document.getElementById('signinEmail').value.trim() || document.getElementById('signupEmail').value.trim();
    if (!email) return showBanner('error', 'Enter an email to reset password');
    try { await auth.sendPasswordResetEmail(email); showBanner('success', 'Reset email sent'); } catch (e) { showBanner('error', e.message); }
  });

  // Phone 2FA: setup reCAPTCHA and functions
  let confirmationResult = null;
  window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { size: 'invisible' });

  document.getElementById('sendCodeBtn').addEventListener('click', async () => {
    const phone = document.getElementById('phoneNumber').value.trim();
    if (!phone) return showBanner('error', 'Enter phone number in international format');
    try {
      const appVerifier = window.recaptchaVerifier;
      confirmationResult = await auth.signInWithPhoneNumber(phone, appVerifier);
      showBanner('info', 'Code sent â€” paste it below and click verify (this will link to your account if signed in)');
    } catch (e) { showBanner('error', e.message); }
  });

  document.getElementById('verifyPhoneBtn').addEventListener('click', async () => {
    const code = document.getElementById('phoneCode').value.trim();
    if (!code || !confirmationResult) return showBanner('error', 'No code or no pending verification');
    try {
      const result = await confirmationResult.confirm(code);
      const phoneUser = result.user;
      // If the currently signed-in user is same as the phone user, great â€” mark phoneVerified
      const cur = auth.currentUser;
      if (cur && cur.uid === phoneUser.uid) {
        await db.ref('users/' + cur.uid + '/phoneVerified').set(true);
        showBanner('success', 'Phone linked and marked verified');
      } else if (cur && cur.email) {
        // if different user (rare), link credentials
        try {
          // link phone credential to current user
          const credential = firebase.auth.PhoneAuthProvider.credential(confirmationResult.verificationId, code);
          await cur.linkWithCredential(credential);
          await db.ref('users/' + cur.uid + '/phoneVerified').set(true);
          showBanner('success', 'Phone linked to your account');
        } catch (linkErr) {
          showBanner('error', 'Could not link phone: ' + linkErr.message);
        }
      } else {
        showBanner('info', 'Signed in with phone number. If you want to link to an email account, sign in to that account and repeat linking.');
      }
    } catch (e) { showBanner('error', e.message); }
  });

  // Invite (email link sign-in) â€” admin can send magic link invites
  const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
  document.getElementById('inviteBtn').addEventListener('click', async () => {
    const email = document.getElementById('inviteEmail').value.trim();
    if (!email) return showBanner('error', 'Enter email to invite');
    try {
      await auth.sendSignInLinkToEmail(email, actionCodeSettings);
      // Save invite so we can track
      await db.ref('invites').push({ email, sentAt: Date.now(), by: auth.currentUser ? auth.currentUser.uid : null });
      showBanner('success', 'Invite sent');
    } catch (e) { showBanner('error', e.message); }
  });

  // Handle email sign-in link (magic link)
  if (auth.isSignInWithEmailLink(window.location.href)) {
    const storedEmail = window.localStorage.getItem('emailForSignIn') || '';
    let email = storedEmail;
    if (!email) {
      email = window.prompt('Please provide your email for confirmation');
    }
    auth.signInWithEmailLink(email, window.location.href).then(async (result) => {
      window.localStorage.removeItem('emailForSignIn');
      await db.ref('users/' + result.user.uid).set({ email: result.user.email, createdAt: Date.now(), phoneVerified: false });
      showBanner('success', 'Signed in with email link');
      window.history.replaceState({}, document.title, '/');
    }).catch((e) => { console.error(e); });
  }

  // ----------------------
  // Role utilities and admin UI
  // ----------------------
  async function isAdmin(uid) {
    const snap = await db.ref('roles/' + uid).once('value');
    const v = snap.val();
    return v && v.role === 'admin';
  }

  async function refreshAdminPanel() {
    const listWrap = document.getElementById('usersList');
    listWrap.innerHTML = 'Loadingâ€¦';
    // fetch users list from users/ node
    const snap = await db.ref('users').once('value');
    const users = snap.val() || {};
    listWrap.innerHTML = '';
    Object.entries(users).forEach(async ([uid, u]) => {
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between py-1 border-b';
      const left = document.createElement('div');
      left.innerHTML = `<div class="text-sm">${u.email || '(no email)'}<div class="text-xs text-gray-500">${u.phoneVerified ? 'phone verified' : 'phone not verified'}</div></div>`;
      const right = document.createElement('div');
      const btn = document.createElement('button');
      btn.className = 'px-2 py-1 rounded text-sm';
      const adminFlag = await isAdmin(uid);
      btn.textContent = adminFlag ? 'Revoke admin' : 'Make admin';
      btn.onclick = async () => {
        await db.ref('roles/' + uid).set({ role: adminFlag ? 'user' : 'admin', changedAt: Date.now(), by: auth.currentUser.uid });
        refreshAdminPanel();
      };
      right.appendChild(btn);
      div.appendChild(left);
      div.appendChild(right);
      listWrap.appendChild(div);
    });
  }

  // ----------------------
  // Faces app logic (same as original) â€” only accessible to authenticated users
  // ----------------------
  let cachedStatus = { is_recognition_active: false, last_active: null, error: "" };
  let faces = [];

  function setStatusUI() {
    const el = document.getElementById('status-indicator');
    const last = document.getElementById('lastActive');
    const err = document.getElementById('statusError');

    if (cachedStatus.error) { err.textContent = cachedStatus.error || ""; } else { err.textContent = ""; }
    last.textContent = cachedStatus.last_active || "â€”";
    if (cachedStatus.is_recognition_active) {
      el.innerHTML = `<span class="bg-green-500/90 px-3 py-1 rounded-full">ðŸŸ¢ Capturing Faces</span>`;
    } else {
      el.innerHTML = `<span class="bg-red-500/90 px-3 py-1 rounded-full">ðŸ”´ Stopped</span>`;
    }
    const btn = document.getElementById('toggleBtn');
    if (btn) { btn.disabled = false; btn.textContent = cachedStatus.is_recognition_active ? "Stop Recognition" : "Start Recognition"; }
  }

  async function fetchStatus() {
    try {
      const res = await fetch(URL_STATUS, { cache: "no-store" });
      const data = await res.json();
      cachedStatus = data || { is_recognition_active: false, last_active: null, error: "Device offline" };
    } catch {
      cachedStatus = { is_recognition_active: false, last_active: cachedStatus.last_active || null, error: "Network error" };
    }
    setStatusUI();
  }

  async function toggleRemote() {
    const btn = document.getElementById("toggleBtn");
    btn.disabled = true; btn.textContent = "Workingâ€¦";
    const desired = !cachedStatus.is_recognition_active;
    try {
      const r = await fetch(URL_CONTROL, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(desired) });
      if (!r.ok) throw new Error("control write failed");
      const start = Date.now(); let ok = false;
      while (Date.now() - start < 8000) { await new Promise(r => setTimeout(r, 800)); await fetchStatus(); if (cachedStatus.is_recognition_active === desired) { ok = true; break; } }
      if (!ok) showBanner('warn', desired ? "Could not confirm start. App may be offline/camera busy." : "Could not confirm stop."); else showBanner('success', desired ? "Capture started." : "Capture stopped.");
    } catch (e) { showBanner('error', 'Remote control failed (network/rules). ' + (e && e.message)); }
    finally { btn.disabled = false; btn.textContent = cachedStatus.is_recognition_active ? "Stop Recognition" : "Start Recognition"; }
  }

  function renderLatest(entry) {
    const cap = document.getElementById("latestCaption");
    const box = document.getElementById("latestImg");
    if (!entry) { cap.textContent = "No images yet"; box.innerHTML = ""; return; }
    cap.textContent = entry.timestamp || "";
    box.innerHTML = `<img class="rounded-lg shadow max-h-72" src="data:image/jpeg;base64,${entry.image_base64}" alt="latest" />`;
  }

  function renderGallery() {
    const g = document.getElementById("gallery");
    const badge = document.getElementById("countBadge");
    g.innerHTML = ""; badge.textContent = faces.length.toString();
    if (!faces.length) { g.innerHTML = `<div class="col-span-full text-gray-400 text-center py-6">No faces yet</div>`; renderLatest(null); return; }
    renderLatest(faces[0]);
    for (const f of faces) {
      const card = document.createElement("div");
      card.className = `relative border rounded-lg overflow-hidden bg-white hover:shadow transition`;
      const imgWrap = document.createElement("div"); imgWrap.className = "cursor-pointer";
      imgWrap.innerHTML = `<img class="w-full aspect-square object-cover" src="data:image/jpeg;base64,${f.image_base64}" alt="${f.timestamp || ""}">`;
      const meta = document.createElement("div"); meta.className = "px-2 py-2 text-xs text-gray-700 flex items-center justify-between";
      meta.innerHTML = `<span class="truncate">${f.timestamp || ""}</span><input type="checkbox" class="h-4 w-4" ${f.selected ? "checked" : ""}>`;
      imgWrap.onclick = () => { f.selected = !f.selected; checkbox.checked = f.selected; card.classList.toggle("ring-2", f.selected); card.classList.toggle("ring-blue-500", f.selected); };
      const checkbox = meta.querySelector("input[type=checkbox]");
      checkbox.addEventListener("change", () => { f.selected = checkbox.checked; card.classList.toggle("ring-2", f.selected); card.classList.toggle("ring-blue-500", f.selected); });
      card.appendChild(imgWrap); card.appendChild(meta); g.appendChild(card);
      if (f.selected) { card.classList.add("ring-2", "ring-blue-500"); }
    }
  }

  async function loadFaces() {
    document.getElementById("refreshBtn").disabled = true;
    try {
      const res = await fetch(URL_FACES, { cache: "no-store" });
      const data = await res.json();
      if (!data) { faces = []; renderGallery(); return; }
      faces = Object.entries(data).map(([key, v]) => ({ key, ...v, selected: false })).sort((a,b) => (new Date(b.timestamp||0)) - (new Date(a.timestamp||0)));
      renderGallery();
    } catch { showBanner('error', 'Failed to load images.'); }
    finally { document.getElementById("refreshBtn").disabled = false; }
  }

  function selectAll(val) { faces.forEach(f => f.selected = val); renderGallery(); }

  function b64ToUint8Array(b64) { const binary = atob(b64); const len = binary.length; const bytes = new Uint8Array(len); for (let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes; }

  async function downloadSelectedZip() {
    const selected = faces.filter(f => f.selected); if (!selected.length) { showBanner('warn','No images selected.'); return; }
    const zip = new JSZip(); selected.forEach((f, idx) => { const bytes = b64ToUint8Array(f.image_base64); const safeTs = (f.timestamp||`img_${idx}`).replace(/[:\s]/g,'_'); zip.file(`${safeTs}_${f.key}.jpg`, bytes); });
    const blob = await zip.generateAsync({ type: 'blob' }); saveAs(blob, `faces_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.zip`);
  }

  async function deleteSelected() {
    const selected = faces.filter(f => f.selected); if (!selected.length) { showBanner('warn','No images selected.'); return; }
    if (!confirm(`Delete ${selected.length} image(s)? This cannot be undone.`)) return;
    let ok=0, fail=0;
    for (const f of selected) {
      try { const r = await fetch(URL_FACE(f.key), { method: 'DELETE' }); if (r.ok) ok++; else fail++; } catch { fail++; }
    }
    showBanner(fail ? 'warn' : 'success', `Deleted ${ok} image(s)` + (fail ? `, failed ${fail}` : ''));
    await loadFaces();
  }

  // wire up buttons
  document.getElementById('toggleBtn').addEventListener('click', async () => {
    // protect: require 2FA if user has phoneVerified and we want protected actions
    const cur = auth.currentUser; if (!cur) return showBanner('error', 'Sign in first');
    const userSnap = await db.ref('users/' + cur.uid).once('value'); const u = userSnap.val() || {};
    if (u.phoneVerified) {
      // require re-verification step â€” here we require that the user has recently verified via phone in this session
      // For demo: require a short confirmation prompt
      if (!confirm('This device is protected by 2FA. Confirm you want to toggle capture.')) return;
    }
    await toggleRemote();
  });
  document.getElementById('refreshBtn').addEventListener('click', async () => { await fetchStatus(); await loadFaces(); });
  document.getElementById('selectAllBtn').addEventListener('click', () => selectAll(true));
  document.getElementById('deselectAllBtn').addEventListener('click', () => selectAll(false));
  document.getElementById('downloadSelBtn').addEventListener('click', downloadSelectedZip);
  document.getElementById('deleteSelBtn').addEventListener('click', deleteSelected);

  // ----------------------
  // Auth state handling
  // ----------------------
  auth.onAuthStateChanged(async (user) => {
    setAuthArea(user);
    if (!user) {
      document.getElementById('controls-section').classList.add('hidden');
      document.getElementById('admin-section').classList.add('hidden');
      return;
    }
    // ensure user record exists
    const uRef = db.ref('users/' + user.uid);
    const snap = await uRef.once('value');
    if (!snap.exists()) await uRef.set({ email: user.email || null, createdAt: Date.now(), phoneVerified: false });

    // show controls
    document.getElementById('controls-section').classList.remove('hidden');
    await fetchStatus(); await loadFaces();
    // show admin if user is admin
    if (await isAdmin(user.uid)) {
      document.getElementById('admin-section').classList.remove('hidden');
      refreshAdminPanel();
    } else {
      document.getElementById('admin-section').classList.add('hidden');
    }
  });

  // Auto-polling (only when signed in)
  setInterval(async () => { if (auth.currentUser) { await fetchStatus(); await loadFaces(); } }, 5000);

  // Security notes printed to console for developer
  console.log('Security notes:');
  console.log('- This demo uses Firebase Auth + Realtime DB roles. For production, enforce rules in Realtime Database and use the Admin SDK to set roles/claims server-side.');
  console.log('- Client-side role checks are only UI-level. Do not rely on them for access control. Use DB/Storage/Firebase rules.');
  console.log('- 2FA here uses phone verification as an optional step. For strong MFA, consider Firebase Multi-Factor Auth (server-side) or passkeys.');
</script>

</body>
</html>
